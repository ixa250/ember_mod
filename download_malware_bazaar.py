import requests
import os
import time

# Thư mục lưu file .zip
SAVE_DIR = "malware_samples"
os.makedirs(SAVE_DIR, exist_ok=True)

# API của MalwareBazaar
API_URL = "https://mb-api.abuse.ch/api/v1/"

# Yêu cầu danh sách 2000 mẫu mới
data = {
    "query": "get_recent",
    "selector": "2000"
}

print("[*] Đang lấy danh sách hash từ MalwareBazaar...")
res = requests.post(API_URL, data=data)
res_json = res.json()

if "data" not in res_json:
    print("❌ Không lấy được dữ liệu. Kiểm tra mạng hoặc IP bị giới hạn.")
    exit()

count = 0

for entry in res_json["data"]:
    sha256 = entry["sha256_hash"]
    
    # FIXED: xử lý nếu signature bị None
    raw_signature = entry.get("signature")
    if raw_signature is None:
        malware_type = "unknown"
    else:
        malware_type = raw_signature.replace(" ", "_")

    filename = f"{malware_type}_{sha256}.zip"
    zip_path = os.path.join(SAVE_DIR, filename)

    # Bỏ qua nếu file đã tồn tại
    if os.path.exists(zip_path):
        print(f"Bỏ qua (đã có): {filename}")
        continue

    print(f"[+] Đang tải: {filename}")
    try:
        download_res = requests.post(API_URL, data={"query": "get_file", "sha256_hash": sha256})
        if download_res.status_code == 200 and download_res.content.startswith(b'PK'):
            with open(zip_path, "wb") as f:
                f.write(download_res.content)
            count += 1
        else:
            print(f"❌ Không tải được: {filename}")
    except Exception as e:
        print(f"❌ Lỗi khi tải {filename}: {e}")

    time.sleep(2)  # delay tránh bị chặn

print(f"\nĐã tải thành công {count} mẫu malware vào thư mục '{SAVE_DIR}'")
print("Lưu ý: Tất cả file đều có mật khẩu giải nén là 'infected'")
