import requests
import os
import time

# ThÆ° má»¥c lÆ°u file .zip
SAVE_DIR = "malware_samples"
os.makedirs(SAVE_DIR, exist_ok=True)

# API cá»§a MalwareBazaar
API_URL = "https://mb-api.abuse.ch/api/v1/"

# YÃªu cáº§u danh sÃ¡ch 100 máº«u má»›i
data = {
    "query": "get_recent",
    "selector": "100"
}

print("[*] Äang láº¥y danh sÃ¡ch hash tá»« MalwareBazaar...")
res = requests.post(API_URL, data=data)
res_json = res.json()

if "data" not in res_json:
    print("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u. Kiá»ƒm tra máº¡ng hoáº·c IP bá»‹ giá»›i háº¡n.")
    exit()

count = 0

for entry in res_json["data"]:
    sha256 = entry["sha256_hash"]
    
    # FIXED: xá»­ lÃ½ náº¿u signature bá»‹ None
    raw_signature = entry.get("signature")
    if raw_signature is None:
        malware_type = "unknown"
    else:
        malware_type = raw_signature.replace(" ", "_")

    filename = f"{malware_type}_{sha256}.zip"
    zip_path = os.path.join(SAVE_DIR, filename)

    # Bá» qua náº¿u file Ä‘Ã£ tá»“n táº¡i
    if os.path.exists(zip_path):
        print(f"â© Bá» qua (Ä‘Ã£ cÃ³): {filename}")
        continue

    print(f"[+] Äang táº£i: {filename}")
    try:
        download_res = requests.post(API_URL, data={"query": "get_file", "sha256_hash": sha256})
        if download_res.status_code == 200 and download_res.content.startswith(b'PK'):
            with open(zip_path, "wb") as f:
                f.write(download_res.content)
            count += 1
        else:
            print(f"âŒ KhÃ´ng táº£i Ä‘Æ°á»£c: {filename}")
    except Exception as e:
        print(f"âŒ Lá»—i khi táº£i {filename}: {e}")

    time.sleep(2)  # delay trÃ¡nh bá»‹ cháº·n

print(f"\nâœ… ÄÃ£ táº£i thÃ nh cÃ´ng {count} máº«u malware vÃ o thÆ° má»¥c '{SAVE_DIR}'")
print("ğŸ” LÆ°u Ã½: Táº¥t cáº£ file Ä‘á»u cÃ³ máº­t kháº©u giáº£i nÃ©n lÃ  'infected'")
