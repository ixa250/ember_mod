import requests
import os
import time
from datetime import datetime, timedelta
import urllib3

# Màu terminal
RED = "\033[91m"
GREEN = "\033[92m"
RESET = "\033[0m"

# Bỏ cảnh báo SSL
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# === CẤU HÌNH ===
MODE = "daily"  # hoặc "hourly"
START_DATE = "2020-02-24"  # YYYY-MM-DD # Lưu ý: Ngày bắt đầu của malware bazaar là 2020-02-24
NUM_DAYS = 1               # Số ngày liên tiếp cần tải
SLEEP_SECONDS = 5  # ← THỜI GIAN NGHỈ giữa các lượt tải

SAVE_DIR = "malware_samples"
HASH_LOG = "downloaded_batches.txt"
DIRECT_IP = "https://178.162.202.48"

# === TẠO THƯ MỤC LƯU TRỮ ===
os.makedirs(SAVE_DIR, exist_ok=True)

# === ĐỌC LOG NHỮNG FILE ĐÃ TẢI TRƯỚC ĐÓ ===
downloaded = set()
if os.path.exists(HASH_LOG):
    with open(HASH_LOG, "r") as f:
        downloaded = set(line.strip() for line in f)

# === VÒNG LẶP TẢI THEO NGÀY ===
start = datetime.strptime(START_DATE, "%Y-%m-%d")
for i in range(NUM_DAYS):
    day = start + timedelta(days=i)
    day_str = day.strftime("%Y-%m-%d")
    zip_name = f"{day_str}.zip"
    url = f"{DIRECT_IP}/malware-bazaar/{MODE}/{zip_name}"
    zip_path = os.path.join(SAVE_DIR, zip_name)

    if day_str in downloaded:
        print(f"Bỏ qua: {zip_name} (đã tải)")
        continue
    print(f"*****************************************************")
    print(f"* Đang tải malware batch: {zip_name}                 ")
    print(f"*****************************************************")
    try:
        res = requests.get(url, verify=False, timeout=30)
        if res.status_code == 200 and res.content.startswith(b'PK'):
            with open(zip_path, "wb") as f:
                f.write(res.content)
            with open(HASH_LOG, "a") as log:
                log.write(day_str + "\n")
            print(f"{GREEN}Tải thành công: {zip_path}{RESET}")
        else:
            print(f"{RED}Không tải được: {zip_name}. Mã lỗi: {res.status_code}{RESET}")
    except Exception as e:
        print(f"{RED}Lỗi khi tải {zip_name}: {e}{RESET}")

    # Nghỉ sau mỗi lần tải
    time.sleep(SLEEP_SECONDS)

print(f"{GREEN} Hoàn tất.")
print(f"{GREEN} Đã tải thành công, tất cả các mẫu malware được lưu tại '{SAVE_DIR}{RESET}'")
print(f"{RED} Lưu ý: Tất cả file đều có mật khẩu giải nén là 'infected'")
